# WebSocket æ¥å£æ–‡æ¡£

## æ¦‚è¿°
æœ¬WebSocketæ¥å£æä¾›å®æ—¶æ•°æ®æŸ¥è¯¢åŠŸèƒ½ï¼Œæ”¯æŒæµå¼SQLç”Ÿæˆå’Œå®æ—¶çŠ¶æ€åé¦ˆã€‚

## ç«¯ç‚¹ä¿¡æ¯
- **rul**: `ws://172.31.24.111:12224/ws`
- **åè®®**: WebSocket
- **åŠŸèƒ½**: å¤„ç†æ•°æ®æŸ¥è¯¢è¯·æ±‚ï¼Œæ”¯æŒæµå¼å“åº”å’Œå®æ—¶çŠ¶æ€æ›´æ–°
- **ä¸»è¦ç‰¹æ€§**:
  - æµå¼SQLç”Ÿæˆ
  - å®æ—¶çŠ¶æ€æ›´æ–°
  - é”™è¯¯è‡ªåŠ¨é‡è¯•æœºåˆ¶
  - SQLé‡å†™åŠŸèƒ½

## è¯·æ±‚æ ¼å¼

### è¿æ¥å»ºç«‹
å®¢æˆ·ç«¯é€šè¿‡WebSocketè¿æ¥åˆ° `/ws` ç«¯ç‚¹ã€‚

### æ¶ˆæ¯æ ¼å¼
å‘é€JSONæ ¼å¼çš„æ¶ˆæ¯ï¼š
```json
{
  "type": "query",
  "query": "æŸ¥è¯¢è¯­å¥"
}
```

**å­—æ®µè¯´æ˜ï¼š**
- `type` (string): æ¶ˆæ¯ç±»å‹ï¼Œå›ºå®šä¸º `"query"`
- `query` (string): è¦æ‰§è¡Œçš„æŸ¥è¯¢è¯­å¥

## å“åº”æµç¨‹è¯¦è§£

### 1. æŸ¥è¯¢å¤„ç†å¼€å§‹
**ç±»å‹**: ç›´æ¥è¿”å›
**æ¶ˆæ¯**: `"æ­£åœ¨å¤„ç†æŸ¥è¯¢è¯·æ±‚..."`

### 2. SQLç”Ÿæˆå‡†å¤‡
**ç±»å‹**: ç›´æ¥è¿”å›
**æ¶ˆæ¯**: `"æ­£åœ¨è°ƒç”¨text2sqlæ¨¡å‹ç”ŸæˆSQLè¯­å¥..."`

### 3. SQLç”Ÿæˆè¿‡ç¨‹
**ç±»å‹**: ğŸ”„ **æµå¼è¿”å›**
**æ¥æº**: `text2sql_chain` æ¨¡å‹çš„æµå¼è¾“å‡º
**ç‰¹ç‚¹**:
- ä½¿ç”¨ `chain.astream()` æ–¹æ³•é€tokenç”Ÿæˆ
- æ¯ä¸ª `chunk.content` ç«‹å³å‘é€ç»™å®¢æˆ·ç«¯
- åŒ…å«0.01ç§’çš„å‘é€é—´éš”æ§åˆ¶æµé€Ÿ
- æ¯æ¬¡å‘é€åŒ…å«å®Œæ•´çš„chunkå†…å®¹
- ç´¯ç§¯æ‰€æœ‰chunkså½¢æˆæœ€ç»ˆSQLè¯­å¥

**ç¤ºä¾‹æµå¼è¾“å‡º**:
```
"SELECT"
"SELECT *"
"SELECT * FROM"
"SELECT * FROM users_table"
"SELECT * FROM users_table WHERE"
"SELECT * FROM users_table WHERE date >= '2024-01-01'"
```

### 4. SQLç”Ÿæˆå®Œæˆæ ‡å¿—
**ç±»å‹**: ç›´æ¥è¿”å›
**æ¶ˆæ¯**: `"DONE"`

### 5. SQLè¯­å¥ç¡®å®š
**ç±»å‹**: ç›´æ¥è¿”å›
**æ¶ˆæ¯**: `"æœ€ç»ˆSQLè¯­å¥: {å¤„ç†åçš„SQLè¯­å¥}"`

**å¤„ç†æµç¨‹**:
1. ä»æµå¼å†…å®¹ä¸­æå–SQLè¯­å¥
2. åº”ç”¨éƒ¨é—¨ç¼©å†™å¤„ç† (`abbr_process` with `distinct_dept_dict`)
3. åº”ç”¨é¡¹ç›®ç¼©å†™å¤„ç† (`abbr_process` with `distinct_project_dict`)
4. è¿”å›æœ€ç»ˆå¤„ç†åçš„SQLè¯­å¥

### 6. SQLæ‰§è¡Œé˜¶æ®µ

#### 6.1 é¦–æ¬¡æ‰§è¡Œ
**ç±»å‹**: ç›´æ¥è¿”å›
**æ¶ˆæ¯**: `"æ­£åœ¨æ‰§è¡ŒSQLæŸ¥è¯¢..."`

#### 6.2 æ‰§è¡ŒæˆåŠŸè·¯å¾„
**ç±»å‹**: ç›´æ¥è¿”å›
**æ¶ˆæ¯**: `"SQLæŸ¥è¯¢æˆåŠŸï¼Œç»“æœè¡Œæ•°: {å®é™…è¡Œæ•°}"`

#### 6.3 æ‰§è¡Œå¤±è´¥ - é‡è¯•æµç¨‹
**ç±»å‹**: ç›´æ¥è¿”å›
**æ¶ˆæ¯åºåˆ—**:
1. `"SQLæŸ¥è¯¢å¤±è´¥: {å…·ä½“é”™è¯¯ä¿¡æ¯}"`
2. `"æ­£åœ¨å°è¯•é‡å†™SQLè¯­å¥..."`
3. `"æ¨¡å‹é‡å†™çš„SQLå†…å®¹: {é‡å†™åçš„å®Œæ•´å†…å®¹}"`
4. `"é‡å†™åçš„SQLè¯­å¥: {æå–å‡ºçš„SQLè¯­å¥}"`

#### 6.4 é‡è¯•æ‰§è¡Œ
**ç±»å‹**: ç›´æ¥è¿”å›
**æ¶ˆæ¯**: `"æ­£åœ¨æ‰§è¡Œé‡å†™åçš„SQLæŸ¥è¯¢..."`

#### 6.5 é‡è¯•ç»“æœ
**ç±»å‹**: ç›´æ¥è¿”å›
**æˆåŠŸæ¶ˆæ¯**: `"é‡å†™åçš„SQLæŸ¥è¯¢æˆåŠŸ"`
**å¤±è´¥æ¶ˆæ¯**: `"é‡å†™åçš„SQLæŸ¥è¯¢ä»ç„¶å¤±è´¥: {å…·ä½“é”™è¯¯ä¿¡æ¯}"`

### 7. é”™è¯¯å¤„ç†

#### 7.1 SQLç”Ÿæˆå¤±è´¥
**ç±»å‹**: ç›´æ¥è¿”å›
**æ¶ˆæ¯**: `"SQLè¯­å¥ç”Ÿæˆå¤±è´¥"`
**è§¦å‘æ¡ä»¶**: `sql_sentence` ä¸º `None`

#### 7.2 æŸ¥è¯¢å¤„ç†å¼‚å¸¸
**ç±»å‹**: ç›´æ¥è¿”å›
**æ¶ˆæ¯**: `"æŸ¥è¯¢å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: {å¼‚å¸¸ä¿¡æ¯}"`
**è§¦å‘æ¡ä»¶**: å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿæœªæ•è·çš„å¼‚å¸¸

## å‡½æ•°å†…éƒ¨è¿”å›å€¼

### æˆåŠŸè¿”å›
```python
{
    "status": "success",
    "sql": "æœ€ç»ˆæ‰§è¡Œçš„SQLè¯­å¥",
    "result": [æŸ¥è¯¢ç»“æœæ•°æ®]
}
```

### å¤±è´¥è¿”å›
```python
{
    "status": "error",
    "message": "é”™è¯¯æè¿°ä¿¡æ¯"
}
```

## å®Œæ•´æ¶ˆæ¯æ—¶åºå›¾

```
å®¢æˆ·ç«¯æŸ¥è¯¢è¯·æ±‚
    â†“
1. "æ­£åœ¨å¤„ç†æŸ¥è¯¢è¯·æ±‚..."                    [ç›´æ¥è¿”å›]
    â†“
2. "æ­£åœ¨è°ƒç”¨text2sqlæ¨¡å‹ç”ŸæˆSQLè¯­å¥..."       [ç›´æ¥è¿”å›]
    â†“
3. [ğŸ”„æµå¼SQLç”Ÿæˆ chunks...]                [æµå¼è¿”å›]
   - "SELECT"
   - "SELECT * FROM"
   - "SELECT * FROM table_name"
   - ...
    â†“
4. "DONE"                                   [ç›´æ¥è¿”å›]
    â†“
5. "æœ€ç»ˆSQLè¯­å¥: SELECT * FROM table_name..." [ç›´æ¥è¿”å›]
    â†“
6. "æ­£åœ¨æ‰§è¡ŒSQLæŸ¥è¯¢..."                      [ç›´æ¥è¿”å›]
    â†“
   [æˆåŠŸåˆ†æ”¯]
7. "SQLæŸ¥è¯¢æˆåŠŸï¼Œç»“æœè¡Œæ•°: 123"              [ç›´æ¥è¿”å›]
    â†“
   [è¿”å›å‡½æ•°ç»“æœ: {"status": "success", ...}]

   [å¤±è´¥åˆ†æ”¯]
7. "SQLæŸ¥è¯¢å¤±è´¥: Table 'table_name' doesn't exist" [ç›´æ¥è¿”å›]
    â†“
8. "æ­£åœ¨å°è¯•é‡å†™SQLè¯­å¥..."                  [ç›´æ¥è¿”å›]
    â†“
9. "æ¨¡å‹é‡å†™çš„SQLå†…å®¹: SELECT * FROM correct_table..." [ç›´æ¥è¿”å›]
    â†“
10. "é‡å†™åçš„SQLè¯­å¥: SELECT * FROM correct_table..." [ç›´æ¥è¿”å›]
    â†“
11. "æ­£åœ¨æ‰§è¡Œé‡å†™åçš„SQLæŸ¥è¯¢..."              [ç›´æ¥è¿”å›]
    â†“
12. [æˆåŠŸ] "é‡å†™åçš„SQLæŸ¥è¯¢æˆåŠŸ"             [ç›´æ¥è¿”å›]
    [å¤±è´¥] "é‡å†™åçš„SQLæŸ¥è¯¢ä»ç„¶å¤±è´¥: Permission denied" [ç›´æ¥è¿”å›]
```

## æŠ€æœ¯å®ç°ç»†èŠ‚

### æµå¼å¤„ç†å®ç°
```python
async def query_insight_generator(chain, query: str, schema: str, ):
    async for chunk in chain.astream({
        "query": query, "schema": schema,
        }):
        yield chunk  # é€ä¸ª token è¾“å‡º
        await asyncio.sleep(0.01)  # æ§åˆ¶æµé€Ÿ

full_content = []
async for chunk in query_insight_generator(text2sql_chain, query, schema,):
    chunk_msg = chunk.content
    await websocket.send_text(chunk_msg)  # å®æ—¶å‘é€æ¯ä¸ªchunk
    full_content.append(chunk_msg)
```

### SQLå¤„ç†æµç¨‹
1. **æå–**: `extract_sql(candidate_sql_sentence)`
2. **éƒ¨é—¨å¤„ç†**: `abbr_process(extract_sql_sentence, distinct_dept_dict)`
3. **é¡¹ç›®å¤„ç†**: `abbr_process(sql_sentence_dept, distinct_project_dict)`

### é”™è¯¯æ¢å¤æœºåˆ¶
- é¦–æ¬¡SQLæ‰§è¡Œå¤±è´¥æ—¶è‡ªåŠ¨è§¦å‘é‡å†™æœºåˆ¶
- ä½¿ç”¨ `sql_rewrite_chain` è¿›è¡ŒSQLé‡å†™
- æä¾›ç¬¬äºŒæ¬¡æ‰§è¡Œæœºä¼š
- é‡è¯•å¤±è´¥åè¿”å›é”™è¯¯ä¿¡æ¯

### ç»“æœå¤„ç†
```python
result = mysql_db.run(sql_sentence, include_columns=True)
if isinstance(result, str):
    result_data = eval(result)
    row_count = len(result_data)
else:
    result_data = result
    row_count = len(result)
```

## æ—¥å¿—è®°å½•
æ‰€æœ‰WebSocketå‘é€çš„æ¶ˆæ¯éƒ½æœ‰å¯¹åº”çš„æ—¥å¿—è®°å½•ï¼Œæ ¼å¼ä¸ºï¼š
```
logger.info(f"WebSocketå‘é€: {message}")
```

æµå¼chunkçš„æ—¥å¿—æ ¼å¼ï¼š
```
logger.info(f"WebSocketå‘é€æµå¼chunk: {chunk_msg}")
```

## æ³¨æ„äº‹é¡¹

1. **è¿æ¥ç®¡ç†**: å®¢æˆ·ç«¯éœ€è¦å¤„ç†WebSocketè¿æ¥æ–­å¼€çš„æƒ…å†µ
2. **æ¶ˆæ¯é¡ºåº**: å»ºè®®å®¢æˆ·ç«¯æŒ‰æ¥æ”¶é¡ºåºå¤„ç†æ¶ˆæ¯ä»¥ä¿æŒçŠ¶æ€ä¸€è‡´æ€§
3. **é”™è¯¯å¤„ç†**: å®¢æˆ·ç«¯åº”èƒ½å¤Ÿå¤„ç†å„ç§é”™è¯¯æ¶ˆæ¯å¹¶ç»™å‡ºç›¸åº”çš„ç”¨æˆ·åé¦ˆ
4. **æµå¼æ•°æ®**: æµå¼SQLç”ŸæˆæœŸé—´å¯èƒ½äº§ç”Ÿå¤§é‡å°æ¶ˆæ¯ï¼Œå®¢æˆ·ç«¯éœ€è¦åˆç†ç¼“å†²å’Œå¤„ç†
5. **å­—ç¬¦ç¼–ç **: æ‰€æœ‰æ¶ˆæ¯ä½¿ç”¨UTF-8ç¼–ç ï¼Œæ”¯æŒä¸­æ–‡å†…å®¹

## ç›¸å…³ä¾èµ–
- `text2sql_chain`: SQLç”Ÿæˆé“¾
- `sql_rewrite_chain`: SQLé‡å†™é“¾
- `mysql_db`: MySQLæ•°æ®åº“è¿æ¥
- `distinct_dept_dict`: éƒ¨é—¨ç¼©å†™å­—å…¸
- `distinct_project_dict`: é¡¹ç›®ç¼©å†™å­—å…¸
- `extract_sql`: SQLæå–å‡½æ•°
- `abbr_process`: ç¼©å†™å¤„ç†å‡½æ•°